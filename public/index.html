<!DOCTYPE html>
<html lang="sv">
<head>
  <meta charset="UTF-8">
  <title>Korrelationer mellan betyg och frånvaro</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet">
  <style>
    body {
      font-family: 'Inter', sans-serif;
      padding: 40px;
      background-color: #f9f9f9;
      color: #333;
    }
    h1, h2 {
      color: #1a237e;
    }
    .container {
      max-width: 1200px;
      margin: auto;
    }
    table {
      border-collapse: collapse;
      width: 100%;
      margin-bottom: 40px;
      background-color: white;
      box-shadow: 0 2px 4px rgba(0,0,0,0.05);
      border-radius: 8px;
      overflow: hidden;
    }
    th, td {
      border: 1px solid #eee;
      padding: 12px;
      text-align: left;
    }
    th {
      background-color: #e3f2fd;
      cursor: pointer;
    }
    .negativ {
      background-color: #ffebee;
    }
    .positiv {
      background-color: #e8f5e9;
    }
    .dashboard {
      display: flex;
      gap: 20px;
      margin-bottom: 30px;
      flex-wrap: wrap;
    }
    .card {
      background: #fff;
      padding: 20px;
      flex: 1;
      min-width: 250px;
      border-radius: 10px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    }
    .card h3 {
      margin-top: 0;
      color: #0d47a1;
    }
    .filter {
      margin-bottom: 20px;
    }
    .filter label {
      margin-right: 10px;
      font-weight: 600;
    }
    .filter select {
      padding: 8px 12px;
      border-radius: 4px;
      border: 1px solid #ccc;
    }
    .tabell-section {
      margin-bottom: 40px;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>Korrelationer mellan betyg och frånvaro</h1>

    <div class="filter">
      <label for="filter">Välj korrelation:</label>
      <select id="filter">
        <option value="alla">Visa alla</option>
        <option value="ogiltig">Ogiltig frånvaro</option>
        <option value="total">Total frånvaro</option>
        <option value="merit">Meritvärde</option>
      </select>

      <label for="lasar-select" style="margin-left:20px;">Läsår:</label>
      <select id="lasar-select">
        <option value="alla">Alla</option>
      </select>

      <label for="arskurs-select" style="margin-left:20px;">Årskurs:</label>
      <select id="arskurs-select">
        <option value="alla">Alla</option>
        <option value="6">Åk 6</option>
        <option value="9">Åk 9</option>
      </select>
    </div>

    <div class="dashboard" id="dashboard"></div>

    <div id="ogiltig-section" class="tabell-section">
      <h2>Ogiltig frånvaro</h2>
      <table id="ogiltig"></table>
    </div>
    <div id="total-section" class="tabell-section">
      <h2>Total frånvaro</h2>
      <table id="total"></table>
    </div>
    <div id="merit-section" class="tabell-section">
      <h2>Meritvärde</h2>
      <table id="merit"></table>
    </div>
  </div>

<script>
const LASAR = "2024-2025";
const JSON_PATH = `json/${LASAR}`;
let dataOgiltig = [], dataTotal = [], dataMerit = [];
const lasarSet = new Set();

function byggTabell(data, tabellId) {
  const table = document.getElementById(tabellId);
  table.innerHTML = "";
  if (!data.length) return;
  const header = Object.keys(data[0]);
  const thead = table.createTHead();
  const row = thead.insertRow();
  header.forEach((key, i) => {
    const cell = row.insertCell();
    cell.outerHTML = `<th onclick="sorteraKolumn('${tabellId}', ${i})">${key}</th>`;
  });
  const tbody = table.createTBody();
  data.forEach(rowData => {
    const row = tbody.insertRow();
    header.forEach(key => {
      const cell = row.insertCell();
      cell.textContent = rowData[key];
      if (key === "Korrelation") {
        const v = parseFloat(rowData[key]);
        if (v > 0.2) cell.classList.add("positiv");
        if (v < -0.2) cell.classList.add("negativ");
      }
    });
  });
}

function sorteraKolumn(tabellId, kolumnIndex) {
  const table = document.getElementById(tabellId);
  const tbody = table.tBodies[0];
  const rows = Array.from(tbody.rows);
  const isNum = !isNaN(parseFloat(rows[0].cells[kolumnIndex].textContent));
  const sorted = rows.sort((a, b) => {
    const valA = a.cells[kolumnIndex].textContent;
    const valB = b.cells[kolumnIndex].textContent;
    return isNum ? valB - valA : valA.localeCompare(valB);
  });
  sorted.forEach(row => tbody.appendChild(row));
}

function filterData(data, year, arskurs) {
  return data.filter(
    r =>
      (year === "alla" || r["Läsår"] === year) &&
      (arskurs === "alla" || String(r["Årskurs"]) === arskurs)
  );
}

function uppdateraTabeller() {
  const year = document.getElementById("lasar-select").value;
  const arskurs = document.getElementById("arskurs-select").value;
  byggTabell(filterData(dataOgiltig, year, arskurs), "ogiltig");
  byggTabell(filterData(dataTotal, year, arskurs), "total");
  byggTabell(filterData(dataMerit, year, arskurs), "merit");
}

function uppdateraLasarDropdown() {
  const select = document.getElementById("lasar-select");
  select.innerHTML = "<option value=\"alla\">Alla</option>";
  Array.from(lasarSet).sort().forEach(y => {
    const opt = document.createElement("option");
    opt.value = y;
    opt.textContent = y;
    select.appendChild(opt);
  });
}

function läggTillKort(titel, värde, klass = "") {
  const card = document.createElement("div");
  card.className = `card ${klass}`;
  card.innerHTML = `<h3>${titel}</h3><p>${värde}</p>`;
  document.getElementById("dashboard").appendChild(card);
}

function visaTabell(varde) {
  ["ogiltig","total","merit"].forEach(id => {
    const sektion = document.getElementById(`${id}-section`);
    sektion.style.display = (varde === "alla" || varde === id) ? "" : "none";
  });
}

document.getElementById("filter").addEventListener("change", e => visaTabell(e.target.value));
document.getElementById("lasar-select").addEventListener("change", uppdateraTabeller);
document.getElementById("arskurs-select").addEventListener("change", uppdateraTabeller);

async function läsJsonData() {
  const filer = [
    "ogiltig_franvaro_pct_ak6.json",
    "ogiltig_franvaro_pct_ak9.json",
    "total_franvaro_pct_ak6.json",
    "total_franvaro_pct_ak9.json",
    "meritvarde_ak6.json",
    "meritvarde_ak9.json"
  ];
  try {
    const jsondata = await Promise.all(
      filer.map(async fil => {
        try {
          const response = await fetch(`${JSON_PATH}/${fil}`);
          if (!response.ok) {
            const msg = `Kunde inte ladda ${fil}`;
            console.error(msg);
            läggTillKort(msg, "", "negativ");
            return [];
          }
          return await response.json();
        } catch (err) {
          const msg = `Fel vid hämtning av ${fil}`;
          console.error(msg, err);
          läggTillKort(msg, "", "negativ");
          return [];
        }
      })
    );
    dataOgiltig = jsondata[0].concat(jsondata[1]);
    dataTotal = jsondata[2].concat(jsondata[3]);
    dataMerit = jsondata[4].concat(jsondata[5]);

    [...dataOgiltig, ...dataTotal, ...dataMerit].forEach(r => lasarSet.add(r["Läsår"]));
    uppdateraLasarDropdown();
    uppdateraTabeller();

    const snittOgiltig = dataOgiltig.length
      ? dataOgiltig.reduce((acc, r) => acc + parseFloat(r.Korrelation || 0), 0) / dataOgiltig.length
      : 0;
    const snittTotal = dataTotal.length
      ? dataTotal.reduce((acc, r) => acc + parseFloat(r.Korrelation || 0), 0) / dataTotal.length
      : 0;
    const snittMerit = dataMerit.length
      ? dataMerit.reduce((acc, r) => acc + parseFloat(r.Korrelation || 0), 0) / dataMerit.length
      : 0;
    const snittMeritAk6 = jsondata[4].length
      ? jsondata[4].reduce((acc, r) => acc + parseFloat(r.Korrelation || 0), 0) / jsondata[4].length
      : 0;
    const snittMeritAk9 = jsondata[5].length
      ? jsondata[5].reduce((acc, r) => acc + parseFloat(r.Korrelation || 0), 0) / jsondata[5].length
      : 0;

    läggTillKort("Medel korrelation – Ogiltig", dataOgiltig.length ? snittOgiltig.toFixed(2) : "N/A");
    läggTillKort("Medel korrelation – Total", dataTotal.length ? snittTotal.toFixed(2) : "N/A");
    läggTillKort("Medel korrelation – Meritvärde", dataMerit.length ? snittMerit.toFixed(2) : "N/A");
    läggTillKort("Åk 6 – Meritvärde", jsondata[4].length ? snittMeritAk6.toFixed(2) : "N/A");
    läggTillKort("Åk 9 – Meritvärde", jsondata[5].length ? snittMeritAk9.toFixed(2) : "N/A");
  } catch (error) {
    console.error("Fel vid läsning av JSON-data:", error);
    läggTillKort("Fel", "Kunde inte ladda data", "negativ");
  }
}

visaTabell("alla");
läsJsonData();
</script>
</body>
</html>